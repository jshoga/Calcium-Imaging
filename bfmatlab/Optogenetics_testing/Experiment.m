classdef Experiment
    properties
        date
        expNo
        groupNo 
        treatment
        numCells
        mask
        cells
        images
    end
    methods
        function obj = Experiment(expFolder,images,mask)
            if nargin == 1
                prePath = [expFolder,'\PreExposure.czi'];
                postPath = [expFolder,'\PostExposure.czi'];

                pre = bfopen(prePath);
                post = bfopen(postPath);

                preImages = pre{1}(:,1);
                postImages = post{1}(:,1);
                regSequence = [preImages;postImages];
                %% Read in images then trace cells in first image
                % First image in experiment
                firstImage = regSequence{1};
                % Initialize mask to be same size as images in experiment
                fullMask = zeros(size(firstImage));
                % Optimizes contrast and shows image.
                imshow(imadjust(firstImage))
                % Convert grayscale image to binary image
                bw = im2bw(imadjust(firstImage));
                % Filters the traced polygons such that traced regions
                % containing the number of pixels between the pixel range
                % provided are kept, and objects outside of the provided range 
                % are excluded.
                bw2 = bwareafilt(bw,[200 2000]);
                % This is the trace program, goes east to begin searching for 
                % adjacent pixels and continues counterclockwise. Inf tells the
                % function to for an unlimited amount of pixels until it 
                % returns to the beginning.
                hold on
                % Fill in cells so that there are no cells in cells
                BW_filled = imfill(bw2,'holes');
                % Store all of the traced cells in variable 'boundaries'
                boundaries = bwboundaries(BW_filled);
                for k = 1:length(boundaries)
                    cellNo = boundaries{k};
                    % Plot all traced cells
                    plot(cellNo(:,2),cellNo(:,1),'g','LineWidth',1.5);
                end
                [l,w] = size(firstImage);   % WHAT ARE THISSSS????!!
                for z=1:length(boundaries)
                    % Store all pixel x coordinates
                    bx = boundaries{z}(:,1);
                    % Store all pixel y coordinates
                    by = boundaries{z}(:,2);
                    % Convert traced shape into a mask
                    bw3 = poly2mask(bx,by,l,w);
                    % Add current mask into a total mask
                    fullMask = fullMask + bw3;
                end
                % Allow the user to circle additional cells if required
                DrawROIcheck = ...
                    questdlg('Would you like to circle another cell?', ...
                    'Checking...','Yes','No','Yes');
                cnt = 1;
                while strcmp(DrawROIcheck,'Yes') == 1
                    h = imfreehand;
                    bw = createMask(h);
                    DrawROIcheck = ...
                        questdlg('Would you like to circle another cell?',...
                        'Checking...','Yes','No','Yes');
                    fullMask = fullMask + bw;
                    cnt = cnt + 1;
                end
                close all
            else
                regSequence = images;
                fullMask = mask;
            end

            % Find connected components (objects, i.e. cells) in mask
            cc = bwconncomp(fullMask,8);
            % Find objects greater than 10 pixels in size
            obj.cells = ...
                cc.PixelIdxList(cellfun('length',cc.PixelIdxList)>10);
            obj.mask = fullMask;
            obj.numCells = length(obj.cells);
            dateIdx = regexp(expFolder,'2015');
            obj.date = expFolder(dateIdx:dateIdx+9);
            obj.images = regSequence;
            obj.expNo = str2double(expFolder(dateIdx+11:dateIdx+12));
            if obj.expNo == 1 || ...
                    obj.expNo == 2 || ...
                    obj.expNo == 3 || ...
                    obj.expNo == 4 || ... 
                    obj.expNo == 5 || ...
                    obj.expNo == 6 || ...
                    obj.expNo == 7 || ...
                    obj.expNo == 57
                obj.groupNo = 1;
            elseif obj.expNo == 8 || ...
                    obj.expNo == 9 || ...
                    obj.expNo == 10 || ...
                    obj.expNo == 11 || ...
                    obj.expNo == 33 || ...
                    obj.expNo == 34
                obj.groupNo = 3;
            elseif obj.expNo == 12 || ...
                    obj.expNo == 13 || ...
                    obj.expNo == 14 || ...
                    obj.expNo == 15 || ...
                    obj.expNo == 16 || ...
                    obj.expNo == 17 || ...
                    obj.expNo == 55
                obj.groupNo = 10;
            elseif obj.expNo == 18 || ...
                    obj.expNo == 19 || ...
                    obj.expNo == 20 || ...
                    obj.expNo == 28 || ...
                    obj.expNo == 29 || ...
                    obj.expNo == 58
                obj.groupNo = 9;
            elseif obj.expNo == 21 || ...
                    obj.expNo == 22 || ...
                    obj.expNo == 23 || ...
                    obj.expNo == 24 || ...
                    obj.expNo == 30
                obj.groupNo = 6;
            elseif obj.expNo == 25 || ...
                    obj.expNo == 26 || ...
                    obj.expNo == 27 || ...
                    obj.expNo == 31 || ...
                    obj.expNo == 32 || ...
                    obj.expNo == 56
                obj.groupNo = 4;
            elseif obj.expNo == 35 || ...
                    obj.expNo == 36 || ...
                    obj.expNo == 37 || ...
                    obj.expNo == 38 || ...
                    obj.expNo == 39
                obj.groupNo = 2;
            elseif obj.expNo == 40 || ...
                    obj.expNo == 41 || ...
                    obj.expNo == 42 || ...
                    obj.expNo == 43 || ...
                    obj.expNo == 44 || ...
                    obj.expNo == 91
                obj.groupNo = 5;
            elseif obj.expNo == 45 || ...
                    obj.expNo == 46 || ...
                    obj.expNo == 47 || ...
                    obj.expNo == 48 || ...
                    obj.expNo == 49 || ...
                    obj.expNo == 105
                obj.groupNo = 7;
            elseif obj.expNo == 50 || ...
                    obj.expNo == 51 || ...
                    obj.expNo == 52 || ...
                    obj.expNo == 53 || ...
                    obj.expNo == 54
                obj.groupNo = 8;
            elseif obj.expNo == 59 || ...
                    obj.expNo == 80 || ...
                    obj.expNo == 81 || ...
                    obj.expNo == 82 || ...
                    obj.expNo == 83 || ...
                    obj.expNo == 92
                obj.groupNo = 11;
            elseif obj.expNo == 60 || ...
                    obj.expNo == 61 || ...
                    obj.expNo == 62 || ...
                    obj.expNo == 63 || ...
                    obj.expNo == 69
                obj.groupNo = 16;
            elseif obj.expNo == 64 || ...
                    obj.expNo == 65 || ...
                    obj.expNo == 66 || ...
                    obj.expNo == 67 || ...
                    obj.expNo == 68
                obj.groupNo = 17;
            elseif obj.expNo == 70 || ...
                    obj.expNo == 71 || ...
                    obj.expNo == 72 || ...
                    obj.expNo == 73 || ...
                    obj.expNo == 74 || ...
                    obj.expNo == 93 || ...
                    obj.expNo == 94 || ...
                    obj.expNo == 95 || ...
                    obj.expNo == 96
                obj.groupNo = 14;
            elseif obj.expNo == 75 || ...
                    obj.expNo == 76 || ...
                    obj.expNo == 77 || ...
                    obj.expNo == 78 || ...
                    obj.expNo == 79
                obj.groupNo = 15;
            elseif obj.expNo == 84 || ...
                    obj.expNo == 85 || ...
                    obj.expNo == 102 || ...
                    obj.expNo == 103 || ...
                    obj.expNo == 104
                obj.groupNo = 12;
            elseif obj.expNo == 86 || ...
                    obj.expNo == 87 || ...
                    obj.expNo == 88 || ...
                    obj.expNo == 89 || ...
                    obj.expNo == 90
                obj.groupNo = 13;
            elseif obj.expNo == 97 || ...
                    obj.expNo == 98 || ...
                    obj.expNo == 99 || ...
                    obj.expNo == 100 || ...
                    obj.expNo == 101
                obj.groupNo = 18;
            end
            if obj.groupNo == 1
                obj.treatment = 'Hypotonic Stress';
            elseif obj.groupNo == 2
                obj.treatment = 'GSK205 TRPV4 Inhibition';
            elseif obj.groupNo == 3
                obj.treatment = 'GSK101 TRPV4 Activation';
            elseif obj.groupNo == 4
                obj.treatment = 'PMA PKC Activation';
            elseif obj.groupNo == 5
                obj.treatment = 'PMA PKC Activation + GSK205 TRPV Inhibition';
            elseif obj.groupNo == 6
                obj.treatment = 'm-3M3FBS PLC Activation + Thapsigargin Ca2+ Store Depletion';
            elseif obj.groupNo == 7
                obj.treatment = 'm-3M3FBS PLC Activation + Calphostin C PKC Inhibition';
            elseif obj.groupNo == 8
                obj.treatment = 'm-3M3FBS PLC Activation + Thapsigargin Ca2+ Store Depletion + Calphostin C PKC Inhibition';
            elseif obj.groupNo == 9
                obj.treatment = 'm-3M3FBS PLC Activation + Thapsigargin Ca2+ Store Depletion + GSK205 TRPV4 Inhibition';
            elseif obj.groupNo == 10
                obj.treatment = 'm-3M3FBS PLC Activation + GSK205 TRPV4 Inhibition';
            elseif obj.groupNo == 11
                obj.treatment = 'm-3M3FBS PLC Activation + Xestospongin C IP3R Inibition';
            elseif obj.groupNo == 12
                obj.treatment = 'm-3M3FBS PLC Activation + Xestospongin C IP3R Inhibition + Calphostin C PKC Inhibition';
            elseif obj.groupNo == 13
                obj.treatment = 'm-3M3FBS PLC Activation + Xestospongin C IP3R Inhibition + GSK205 TRPV4 Inhibition';
            elseif obj.groupNo == 14
                obj.treatment = 'Epinephrine';
            elseif obj.groupNo == 15
                obj.treatment = 'Norepinephrine';
            elseif obj.groupNo == 16
                obj.treatment = 'HBSS Control';
            elseif obj.groupNo == 17
                obj.treatment = 'DMSO Control';
            elseif obj.groupNo == 18
                obj.treatment = 'Epinephrine + Xestospongin C IP3R Inhibition + GSK205 TRPV4 Inhibition';
            end
        end
    end
end
